# åç«¯æ€§èƒ½æµ‹è¯•(å‹æµ‹)

## ä¸€ã€å‹æµ‹å‡†å¤‡

### 1ã€å‹æµ‹çš„ç›®çš„

å‹æµ‹å…¶å®æœ‰ä¸¤ä¸ªç›®çš„ï¼š

1. æµ‹è¯•åº”ç”¨åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹æ˜¯å¦ä¼šæŠ¥é”™ï¼Œè¿›ç¨‹æ˜¯å¦ä¼šæŒ‚æ‰ï¼›â†’ä¿è¯ä¸Šçº¿åç³»ç»Ÿä¸å‡ºé—®é¢˜
2. æµ‹è¯•åº”ç”¨çš„æŠ—å‹èƒ½åŠ›ï¼Œé¢„ä¼°åº”ç”¨çš„æ‰¿è½½èƒ½åŠ›ï¼ˆæ‰¾åˆ°ç³»ç»Ÿçš„ç“¶é¢ˆï¼‰ã€‚â†’å‹å‡ºæé™ï¼Œä¸ºè¿ç»´åŒå­¦æä¾›æ‰©å®¹çš„ä¾æ®

### 2ã€ç³»ç»Ÿå¯èƒ½å­˜åœ¨çš„ç“¶é¢ˆ

æ•°æ®åº“ï¼Œæ•°æ®åº“çš„CPUæˆ–è€…ç£ç›˜IO

åº”ç”¨ï¼Œåº”ç”¨é˜¿æœåŠ¡å™¨çš„CPUã€å†…å­˜å’ŒIOç­‰

##### ä¸¾ä¸ªä¾‹å­ğŸŒ°

å¯¹äºä¸€äº›æ€§èƒ½æœ‰é«˜è¦æ±‚çš„å…¬å¸ï¼Œæ¯”æ–¹è¯´ä¸ƒç‰›äº‘ï¼Œæ®è¯´ä»–ä»¬åªæ¥å—*ç½‘ç»œIO*è¿™ä¸€ç“¶é¢ˆï¼Œå‹æµ‹çš„æ—¶å€™ï¼Œæ˜¯ä¸€å®šè¦æŠŠåƒå…†ç½‘å¡è·‘æ»¡ï¼Œæ‰ç®—æ˜¯æ€§èƒ½è¾¾æ ‡ï¼›å¦‚æœç½‘å¡æ²¡è·‘æ»¡ï¼Œé‚£å°±è¯´æ˜ç“¶é¢ˆæ˜¯åœ¨åˆ«çš„åœ°æ–¹ï¼Œè¦å»ä¸æ–­ä¼˜åŒ–ï¼Œç›´åˆ°ç½‘å¡çš„ç‰©ç†é™åˆ¶æˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚

### 3ã€å»¶è¿Ÿå’Œåå

å»¶è¿Ÿlatencyä¸ååthoughputï¼Œæ˜¯ä¸¤ä¸ªç›¸å…³ï¼Œä½†å…¶å®ç‹¬ç«‹çš„æ¦‚å¿µã€‚

æœ€ç†æƒ³çš„ç³»ç»Ÿæ˜¯ä½å»¶è¿Ÿï¼Œé«˜ååï¼›ä½†æœ‰æ—¶é«˜å»¶è¿Ÿçš„ç³»ç»Ÿï¼Œååæ˜¯å¯ä»¥è¶…è¿‡ä½å»¶è¿Ÿçš„ç³»ç»Ÿçš„ã€‚

### 4ã€å‹æµ‹æŒ‡æ ‡

ç›®æ ‡QPSï¼ˆæ¯ç§’æŸ¥è¯¢ç‡,ä¹Ÿå°±æ˜¯å•ä½æ—¶é—´å†…æœ€å¤§è¯·æ±‚æ•°ï¼‰å’ŒRTï¼ˆå“åº”æ—¶é—´ï¼‰

å‚è€ƒæ–‡ç« ï¼š[æœ€å¤§QPSæ¨å¯¼](https://www.atatech.org/articles/27548?spm=ata.13269325.0.0.667d49farEp1vc#3)    [RT/QPSæ¦‚å¿µè¾¨æ](https://www.atatech.org/articles/4690?spm=ata.13269325.0.0.667d49farEp1vc#0)

#### RTï¼ˆå“åº”æ—¶é—´ï¼‰

> å…¬å¼ä¸€: RT = Thread CPU Time + Thread Wait Time

RTï¼ˆResponse Timeï¼‰å¯ä»¥ç®€å•çš„ç†è§£ä¸ºç³»ç»Ÿä»è¾“å…¥åˆ°è¾“å‡ºçš„æ—¶é—´é—´éš”ï¼Œç³»ç»Ÿå¯ä»¥æŒ‡ä¸€ä¸ªç½‘ç«™æˆ–è€…ä¸€ä¸ªå…¶ä»–ç±»å‹çš„è½¯ä»¶åº”ç”¨ï¼Œä¹Ÿå¯ä»¥æŒ‡æŸä¸ªè®¾å¤‡ï¼Œæ¯”å¦‚è¯´æ‰‹æœºï¼Œæ‰‹æœºç•Œé¢ä¹Ÿæœ‰å“åº”æ—¶é—´ã€‚æ‰€ä»¥RTæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¹¿æ³›çš„æ¦‚å¿µï¼Œä¸è¿‡åœ¨æ¥ä¸‹æ¥çš„åœºæ™¯ï¼ŒRTéƒ½å°†ä¼šç‰¹æŒ‡æˆ‘ä»¬çš„äº’è”ç½‘åº”ç”¨ï¼š

1. å¯¹äºæœåŠ¡å™¨ç«¯RTæ¥è¯´ï¼Œå®ƒçš„å«ä¹‰æ˜¯æŒ‡ä»æœåŠ¡å™¨æ¥å—åˆ°è¯·æ±‚åˆ°è¯¥è¯·æ±‚çš„å“åº”çš„å…¨éƒ¨æ•°æ®è¢«å‘å¾€å®¢æˆ·ç«¯ã€‚
2. å¯¹äºå®¢æˆ·ç«¯RTæ¥è¯´ï¼Œå®ƒçš„å«ä¹‰æ˜¯æŒ‡ä»å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚è¯´æµè§ˆå™¨ï¼‰å‘èµ·è¯·æ±‚åˆ°å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚è¯´æµè§ˆå™¨ï¼‰æ¥å—åˆ°è¯¥è¯·æ±‚çš„å“åº”çš„å…¨éƒ¨æ•°æ®çš„æ—¶é—´é—´éš”ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯æœåŠ¡å™¨ç«¯çš„RT+ç½‘ç»œå¼€é”€çº¦ç­‰äºå®¢æˆ·ç«¯çš„RTã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå·®çš„ç½‘ç»œç¯å¢ƒå¯ä»¥é€ æˆä¸¤ä¸ªRTæ‚¬æ®Šçš„å·®è·ï¼ˆæ¯”å¦‚è¯´ä»ä¿„ç½—æ–¯åˆ°ç¾å›½ï¼ŒRTè¿œå¤§äºå›½å†…ç½‘ç»œç¯å¢ƒï¼‰ã€‚

å®¢æˆ·ç«¯çš„RTç›´æ¥å½±å“ç€ç”¨æˆ·ä½“éªŒï¼Œè¦é™ä½å®¢æˆ·ç«¯RTä»è€Œæå‡ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘ä¸¤ç‚¹ï¼Œä¸€ä¸ªæ˜¯æœåŠ¡å™¨ç«¯çš„RTï¼Œç¬¬äºŒä¸ªæ˜¯ç½‘ç»œã€‚

- å¯¹äºç½‘ç»œæ¥è®²ï¼Œå¸¸è§çš„ä¼˜åŒ–æ–¹å¼æœ‰CDNï¼ŒADNï¼Œä¸“çº¿ï¼Œè¿™äº›éƒ½é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚

- **è€Œå¯¹äºæœåŠ¡å™¨ç«¯RTè¿™ä¸ªå‘½é¢˜æ¥è¯´ï¼Œä¸»è¦å°±æ˜¯çœ‹æˆ‘ä»¬æœåŠ¡å™¨ç«¯çš„åšæ³•äº†ï¼Œä»å…¬å¼ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¦é™ä½RTï¼Œå°±æ˜¯éœ€è¦é™ä½Thread CPU Timeæˆ–è€…Thread Wait Timeã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šç€é‡è®¨è®ºæœåŠ¡å™¨RTï¼ŒThread CPU Timeï¼ŒThread Wait Timeç›¸å…³çŸ¥è¯†ã€‚**

#### QPSï¼ˆæ¯ç§’æŸ¥è¯¢ç‡ï¼‰

##### **æ¦‚å¿µï¼š**

æ¯ç§’æŸ¥è¯¢ç‡,ä¹Ÿå°±æ˜¯å•ä½æ—¶é—´å†…æœ€å¤§è¯·æ±‚æ•°

å¦‚æœç³»ç»Ÿé‡Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ–è€…ä¸€ä¸ªè¿›ç¨‹ï¼ˆè¯¥è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œé‚£ä¹ˆæœ€å¤§çš„QPSæ˜¯1000ms/RTï¼ˆRTçš„å•ä½ä¹Ÿæ˜¯msï¼‰ï¼Œå‡è®¾RTæ˜¯199msï¼ˆCPU Timeä¸º19msï¼ŒWait Timeæ˜¯180msï¼‰ï¼Œé‚£ä¹ˆ1000msä»¥å†…ï¼Œç³»ç»Ÿå¯ä»¥æ¥å—çš„æœ€å¤§è¯·æ±‚å°±æ˜¯1000ms/(19ms+180ms)=5.025ã€‚

æ‰€ä»¥å•çº¿ç¨‹çš„QPSå˜æˆäº†

> å•çº¿ç¨‹QPS=1000ms/RT

##### **QPSçš„å½±å“å› ç´ ï¼š**

- QPSä¸»è¦æ˜¯ä½ çš„ä¸šåŠ¡é€»è¾‘å†³å®šçš„ï¼Œä¸šåŠ¡é€»è¾‘è¶Šå¤æ‚ï¼ŒQPSè¶Šä½ã€‚
- QPSæ˜¯å—åˆ°æ•°æ®ç»“æ„å’Œç®—æ³•çš„å½±å“ã€‚
- QPSæ˜¯å—åˆ°çº¿ç¨‹æ•°çš„å½±å“ã€‚
- QPSæ˜¯å—åˆ°ç³»ç»Ÿç“¶é¢ˆçš„å½±å“ã€‚
- QPSå’ŒRTå…³ç³»éå¸¸ç´§å¯†ã€‚

##### æ€ä¹ˆä¼°ç®—QPS

ä¸»è¦æ ¹æ®PVï¼ˆç”¨æˆ·è®¿é—®æ¬¡æ•°ï¼‰ï¼ŒåŒ…æ‹¬æ—¥å‡å’Œå³°å€¼ã€‚

ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š

> ã€æœ¯è¯­è¯´æ˜ã€‘
> QPS = req/sec = è¯·æ±‚æ•°/ç§’  QPS=queries per second
>
> PV=page view
> TPS=transactions per second
>
> RPS=requests per second     RPS=å¹¶å‘æ•°/å¹³å‡å“åº”æ—¶é—´
>
> ã€QPSè®¡ç®—PVå’Œæœºå™¨çš„æ–¹å¼ã€‘
>
> QPSç»Ÿè®¡æ–¹å¼ [ä¸€èˆ¬ä½¿ç”¨ http_load è¿›è¡Œç»Ÿè®¡]
> QPS = æ€»è¯·æ±‚æ•° / ( è¿›ç¨‹æ€»æ•° * è¯·æ±‚æ—¶é—´ )
> QPS: å•ä¸ªè¿›ç¨‹æ¯ç§’è¯·æ±‚æœåŠ¡å™¨çš„æˆåŠŸæ¬¡æ•°
>
> å•å°æœåŠ¡å™¨æ¯å¤©PVè®¡ç®—
> å…¬å¼1ï¼šæ¯å¤©æ€»PV = QPS * 3600 * 6
> å…¬å¼2ï¼šæ¯å¤©æ€»PV = QPS * 3600 * 8
>
> æœåŠ¡å™¨è®¡ç®—
> æœåŠ¡å™¨æ•°é‡ = ceil( æ¯å¤©æ€»PV / å•å°æœåŠ¡å™¨æ¯å¤©æ€»PV )
>
> ã€å³°å€¼QPSå’Œæœºå™¨è®¡ç®—å…¬å¼ã€‘
>
> åŸç†ï¼šæ¯å¤©80%çš„è®¿é—®é›†ä¸­åœ¨20%çš„æ—¶é—´é‡Œï¼Œè¿™20%æ—¶é—´å«åšå³°å€¼æ—¶é—´
> å…¬å¼ï¼š( æ€»PVæ•° * 80% ) / ( æ¯å¤©ç§’æ•° * 20% ) = å³°å€¼æ—¶é—´æ¯ç§’è¯·æ±‚æ•°(QPS)
> æœºå™¨ï¼šå³°å€¼æ—¶é—´æ¯ç§’QPS / å•å°æœºå™¨çš„QPS = éœ€è¦çš„æœºå™¨
>
> é—®ï¼šæ¯å¤©300w PV çš„åœ¨å•å°æœºå™¨ä¸Šï¼Œè¿™å°æœºå™¨éœ€è¦å¤šå°‘QPSï¼Ÿ
> ç­”ï¼š( 3000000 * 0.8 ) / (86400 * 0.2 ) = 139 (QPS)
>
> é—®ï¼šå¦‚æœä¸€å°æœºå™¨çš„QPSæ˜¯58ï¼Œéœ€è¦å‡ å°æœºå™¨æ¥æ”¯æŒï¼Ÿ
> ç­”ï¼š139 / 58 = 3

## äºŒã€å‹æµ‹æ‰§è¡Œ

#### å…·ä½“æ­¥éª¤

OPMï¼š

1. å‡†å¤‡æ•°æ®ï¼šæ¯”å¦‚user_idï¼Œå¯ä»¥ä¸Šä¼ åˆ°OPMï¼Œä¾¿äºä¹‹åå…³è”æ•°æ®æº
2. æ–°å¢å‹æµ‹é“¾è·¯ï¼šæ·»åŠ è§„åˆ™ï¼Œæ¥å£çš„åŒä¸€ä¸ªå…¥å‚å¯èƒ½å¯¹åº”ä¸åŒæ–¹å¼ï¼Œæ¯”å¦‚ä¸“åœºæœ‰å¾ˆå¤šç§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å»ºç«‹å¤šä¸ªè§„åˆ™ï¼Œæ³¨æ„è§„åˆ™éœ€è¦é…ç½®ç›¸åº”çš„å…¥å‚ï¼›å¯ä»¥æ·»åŠ å­—æ®µuser_idï¼Œæ¥å…³è”ä¹‹å‰å‡†å¤‡çš„æ•°æ®
3. æ–°å»ºéœ€æ±‚ï¼Œè®¾ç½®QPSå¹¶æ¨é€éœ€æ±‚åˆ°Amazonï¼šä¸€ä¸ªéœ€æ±‚å¯ä»¥æ·»åŠ å¤šä¸ªé“¾è·¯
4. ç‚¹å‡»æ‰§è¡Œéœ€æ±‚

Amazon

1. æ–°å¢å‹æµ‹è®¡åˆ’ï¼šæ ¹æ®OPMæ¨é€è¿‡æ¥çš„å·²æœ‰éœ€æ±‚
2. è®¾ç½®QPS
3. 

ATPï¼š

éœ€è¦Amazonçš„éœ€æ±‚idï¼Œopmçš„éœ€æ±‚åœ°å€ï¼ŒAmazonçš„éœ€æ±‚åœ°å€ï¼Œä»è€Œå»ºç«‹å‹æµ‹åœºæ™¯ã€‚

#### å‡†å¤‡æ•°æ®

ä¸¤éƒ¨åˆ†æ•°æ®ï¼š

1. åŸºç¡€æ•°æ®
2. å‹æµ‹æ•°æ®

#### æ–°å¢å‹æµ‹é“¾è·¯

OPMæµ‹è¯•ä¸­å¿ƒï¼š

1. æ–°å¢å‹æµ‹é“¾è·¯ï¼Œé€‰æ‹©mtopæ¥å£

2. é€‰æ‹©api

3. å¡«å†™ä¿¡æ¯ï¼Œå…³è”**å‹æµ‹æ•°æ®æº**ï¼Œæ·»åŠ **è§„åˆ™**

   ![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/969a2b5dd07c5c5aa735259d8bb8bd63.png)

4. åˆ›å»ºå‹æµ‹éœ€æ±‚

   ï¼ˆ1ï¼‰æ–°å¢éœ€æ±‚ï¼š![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/f5488d87ccec21f671468fb89f464edd.png)

   ï¼ˆ2ï¼‰å¡«å†™ä¿¡æ¯å¹¶ä¿å­˜éœ€æ±‚

   ![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/997ff9d732c57679918c89c708d01eb5.png)

   ï¼ˆ3ï¼‰å®Œæˆå†…å®¹å¡«å†™ä¹‹åï¼Œé¦–å…ˆä¿å­˜éœ€æ±‚ï¼Œç„¶åç‚¹å‡»â€œé‡æ–°åŒæ­¥éœ€æ±‚å’Œæ•°æ®åˆ°Amazonâ€ã€‚

   ![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/f87a84aa21080dff985e86aa7549d097.png)

   ï¼ˆ4ï¼‰åŒæ­¥å®Œæˆä¹‹åï¼Œä¼šå‡ºç°å‹æµ‹æ•°æ®çš„OSSåœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤º

   ![image.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/967a788f1fb28b855be2bc8820d32c32.png)

OPMå‹æµ‹é“¾è·¯åˆ—è¡¨ï¼š

http://opm.m.taobao.com/press_link_list.htm?spm=0.0.0.0.wxabIa

OPMå‹æµ‹éœ€æ±‚åˆ—è¡¨ï¼š

http://opm.m.taobao.com/press_requirement_list.htm?spm=0.0.0.0.I4RjJP

### Amazon

å…¨é“¾è·¯å‹æµ‹

Amazonï¼š http://mw.alibaba-inc.com/product-amazon.html



### é¹°çœ¼eagleeye

#### æ—¥å¿—é“¾è·¯æŸ¥è¯¢ï¼šé¹°çœ¼

å¹³å°åœ°å€ï¼šhttps://eagleeye-console.alibaba-inc.com/?spm=ata.13261165.0.0.145476d1DVGxkA#/tracing/list

**ä½œç”¨ï¼š**

â€‹	<font color=red>æ€§èƒ½æµ‹è¯•å’Œé“¾è·¯åˆ†æã€æ—¥å¿—åˆ†æçš„æ—¶å€™ä½¿ç”¨</font>

â€‹	æŸ¥çœ‹æŸä¸ªæœåŠ¡ï¼ˆhttpæˆ–æ˜¯hsfæœåŠ¡ï¼‰è°ƒç”¨é“¾ï¼Œå¯ä»¥æŸ¥çœ‹æ—¶é•¿å’Œè°ƒç”¨çš„åº”ç”¨ã€‚æ ¹æ®æ—¶é•¿åˆ†ææ¥å£æ€§èƒ½ã€‚

**æ­¥éª¤ï¼š**

1. è·å–traceIdï¼š

   ![image-20191017111914605](/Users/baola/Library/Application Support/typora-user-images/image-20191017111914605.png)

2. é€šè¿‡traceIdåœ¨é¹°çœ¼å¹³å°è¿›è¡Œæœç´¢ï¼Œå³å¯æŸ¥çœ‹å®æ—¶è°ƒç”¨é“¾è·¯ã€‚

   ![image-20190908132053923](/Users/baola/Library/Application Support/typora-user-images/image-20190908132053923.png)

æ–¹æ³•äºŒï¼š

â€‹	ç›´æ¥æœåº”ç”¨åå­—ï¼Œç„¶åæŸ¥çœ‹[è°ƒç”¨é“¾å®æ—¶è¯Šæ–­]
â€‹	![image-20191017112134838](/Users/baola/Library/Application Support/typora-user-images/image-20191017112134838.png)

## ä¸‰ã€çªç ´å‹æµ‹ç“¶é¢ˆ

1. å°½é‡å‡å°‘æ•°æ®åº“æ“ä½œï¼ˆå¯ä»¥é‡‡ç”¨ç¼“å­˜ï¼‰
2. é‡‡ç”¨è¿æ¥æ± 
3. é€»è¾‘å°½é‡ç®€å•
4. å¦‚æœé€»è¾‘ç¡®å®å¤æ‚ï¼Œå°±é‡‡ç”¨å¼‚æ­¥æ¥è§£å†³

